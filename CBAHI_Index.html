<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          sans-serif;
        background: linear-gradient(135deg, #0d6efd, #6610f2);
        min-height: 100vh;
      }

      .app-shell {
        padding: 20px;
      }

      .dashboard-card {
        background: #ffffff;
        border-radius: 1.5rem;
        padding: 1.5rem 1.75rem;
        box-shadow: 0 16px 40px rgba(0, 0, 0, 0.25);
        margin-bottom: 1.5rem;
      }

      .page-title {
        font-weight: 700;
        letter-spacing: 0.03em;
      }

      .subtitle {
        opacity: 0.85;
      }

      .summary-card {
        border-radius: 1.25rem;
        padding: 1rem 1.25rem;
        color: #fff;
      }

      .summary-total {
        background: linear-gradient(135deg, #0d6efd, #17a2b8);
      }

      .summary-done {
        background: linear-gradient(135deg, #198754, #20c997);
      }

      .summary-almost {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
      }

      .summary-pending {
        background: linear-gradient(135deg, #dc3545, #6f42c1);
      }

      .status-pill {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
        color: #fff;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .status-done {
        background-color: #198754;
      }

      .status-almost {
        background-color: #ffc107;
        color: #212529;
      }

      .status-pending {
        background-color: #dc3545;
      }

      .status-row-done {
        border-left: 6px solid #198754;
        background: rgba(25, 135, 84, 0.03);
      }

      .status-row-almost {
        border-left: 6px solid #ffc107;
        background: rgba(255, 193, 7, 0.04);
      }

      .status-row-pending {
        border-left: 6px solid #dc3545;
        background: rgba(220, 53, 69, 0.04);
      }

      table tbody tr {
        transition: background-color 0.15s ease, transform 0.05s ease;
      }

      table tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.06);
        transform: translateY(-1px);
      }

      .form-section-title {
        font-weight: 600;
        font-size: 1.05rem;
      }

      .footer-text {
        text-align: center;
        font-weight: 600;
        margin-top: 1.5rem;
        color: #f8f9fa;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
      }

      .footer-text span {
        background: rgba(0, 0, 0, 0.2);
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
      }

      .badge-legend {
        font-size: 0.7rem;
      }

      @media (max-width: 768px) {
        .dashboard-card {
          border-radius: 1rem;
          padding: 1.25rem 1.25rem;
        }

        .page-title {
          font-size: 1.35rem;
        }
      }

      /* Print styling for A4 PDF */
      @media print {
        @page {
          size: A4 portrait;
          margin: 10mm;
        }

        body {
          background: #ffffff !important;
        }

        .no-print {
          display: none !important;
        }

        .dashboard-card {
          box-shadow: none !important;
          margin-bottom: 0.75rem;
        }

        .footer-text {
          color: #444 !important;
          text-shadow: none !important;
        }
      }
    </style>
  </head>

  <body>
    <div class="app-shell container-fluid">
      <!-- HEADER -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="dashboard-card">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
              <div>
                <h2 class="page-title mb-1 text-primary">
                  CBAHI Checklist - Nursing
                </h2>
                <p class="subtitle mb-0 text-muted">
                  Track CBAHI standards, update status, visualize compliance & print A4 reports in one click.
                </p>
              </div>
              <div class="d-flex gap-2 mt-2 mt-md-0 no-print">
                <button
                  class="btn btn-outline-secondary btn-sm"
                  type="button"
                  onclick="handleRefresh()"
                >
                  üîÑ Refresh
                </button>
                <button
                  class="btn btn-outline-primary btn-sm"
                  type="button"
                  onclick="window.print()"
                >
                  üñ®Ô∏è Print / Save as PDF
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SUMMARY + CHART -->
      <div class="row">
        <div class="col-lg-8 mb-3">
          <div class="dashboard-card">
            <div class="row g-3">
              <div class="col-sm-3 col-6">
                <div class="summary-card summary-total text-center">
                  <div class="small text-uppercase fw-semibold">Total Items</div>
                  <div
                    id="totalTasks"
                    class="h3 mb-0 mt-1 fw-bold"
                  >
                    0
                  </div>
                </div>
              </div>
              <div class="col-sm-3 col-6">
                <div class="summary-card summary-done text-center">
                  <div class="small text-uppercase fw-semibold">Done</div>
                  <div
                    id="donePercent"
                    class="h3 mb-0 mt-1 fw-bold"
                  >
                    0%
                  </div>
                  <div class="small" id="doneCountText"></div>
                </div>
              </div>
              <div class="col-sm-3 col-6">
                <div class="summary-card summary-almost text-center">
                  <div class="small text-uppercase fw-semibold">
                    Almost done
                  </div>
                  <div
                    id="almostPercent"
                    class="h3 mb-0 mt-1 fw-bold"
                  >
                    0%
                  </div>
                  <div class="small" id="almostCountText"></div>
                </div>
              </div>
              <div class="col-sm-3 col-6">
                <div class="summary-card summary-pending text-center">
                  <div class="small text-uppercase fw-semibold">
                    Still pending
                  </div>
                  <div
                    id="pendingPercent"
                    class="h3 mb-0 mt-1 fw-bold"
                  >
                    0%
                  </div>
                  <div class="small" id="pendingCountText"></div>
                </div>
              </div>
            </div>

            <hr class="my-3" />

            <div class="row align-items-center">
              <div class="col-md-7">
                <h6 class="mb-2">Compliance status distribution</h6>
                <canvas id="statusChart" height="130"></canvas>
              </div>
              <div class="col-md-5">
                <div class="small text-muted mb-2">
                  Legend:
                </div>
                <div class="mb-1">
                  <span
                    class="status-pill status-done badge-legend"
                  >
                    Done
                  </span>
                  <span class="ms-2 text-muted small">
                    Fully compliant items
                  </span>
                </div>
                <div class="mb-1">
                  <span
                    class="status-pill status-almost badge-legend"
                  >
                    Almost done
                  </span>
                  <span class="ms-2 text-muted small">
                    In progress / nearly compliant
                  </span>
                </div>
                <div>
                  <span
                    class="status-pill status-pending badge-legend"
                  >
                    Still pending
                  </span>
                  <span class="ms-2 text-muted small">
                    Not started or non-compliant
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- FORM -->
        <div class="col-lg-4 mb-3">
          <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="form-section-title">
                CBAHI item details
              </div>
              <button
                class="btn btn-sm btn-outline-secondary no-print"
                type="button"
                onclick="resetForm()"
              >
                ‚ûï New
              </button>
            </div>

            <form id="taskForm" class="small">
              <input type="hidden" id="rowNumber" />
              <input type="hidden" id="idField" />

              <div class="mb-2">
                <label class="form-label mb-1">Date</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="dateInput"
                  placeholder="e.g., 21-11-2025"
                />
              </div>

              <div class="mb-2">
                <label class="form-label mb-1">Point / Item</label>
                <textarea
                  class="form-control form-control-sm"
                  id="pointsInput"
                  rows="2"
                  placeholder="Describe the CBAHI requirement / gap"
                ></textarea>
              </div>

              <div class="mb-2">
                <label class="form-label mb-1">Category / Standard</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="categoryInput"
                  placeholder="Medication safety, Documentation, Rota..."
                />
              </div>

              <div class="mb-2">
                <label class="form-label mb-1">Responsibility</label>
                <input
                  type="text"
                  class="form-control form-control-sm"
                  id="responsibilityInput"
                  placeholder="Name of nurse / team / leader"
                />
              </div>

              <div class="mb-2">
                <label class="form-label mb-1">Status</label>
                <select
                  id="statusInput"
                  class="form-select form-select-sm"
                >
                  <option value="">Select...</option>
                  <option value="Done">Done</option>
                  <option value="Almost done">Almost done</option>
                  <option value="Still pending">Still pending</option>
                </select>
              </div>

              <div class="mb-2">
                <label class="form-label mb-1">Comment / Action plan</label>
                <textarea
                  class="form-control form-control-sm"
                  id="commentInput"
                  rows="2"
                  placeholder="Corrective action, follow-up date, notes..."
                ></textarea>
              </div>

              <div class="d-flex justify-content-between mt-3 no-print">
                <button
                  type="button"
                  class="btn btn-primary btn-sm"
                  onclick="handleSave()"
                >
                  üíæ Save
                </button>
                <button
                  type="button"
                  class="btn btn-outline-danger btn-sm"
                  onclick="handleDelete()"
                >
                  üóëÔ∏è Delete
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- FILTER + TABLE -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="dashboard-card">
            <div
              class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-2"
            >
              <div class="form-section-title">
                CBAHI checklist items
              </div>
              <div class="d-flex flex-wrap gap-2 no-print">
                <select
                  id="statusFilter"
                  class="form-select form-select-sm"
                  style="width: 180px"
                  onchange="renderTable()"
                >
                  <option value="ALL">All statuses</option>
                  <option value="Done">Done</option>
                  <option value="Almost done">Almost done</option>
                  <option value="Still pending">Still pending</option>
                </select>
                <input
                  type="text"
                  id="searchInput"
                  class="form-control form-control-sm"
                  style="width: 220px"
                  placeholder="Search in items / comments..."
                  oninput="renderTable()"
                />
              </div>
            </div>

            <div class="table-responsive">
              <table
                class="table table-sm align-middle mb-0"
              >
                <thead class="table-light">
                  <tr>
                    <th style="width: 40px">#</th>
                    <th style="width: 100px">Date</th>
                    <th>Point / Item</th>
                    <th style="width: 160px">Category / Standard</th>
                    <th style="width: 160px">Responsibility</th>
                    <th style="width: 130px">Status</th>
                    <th>Comment / Action plan</th>
                    <th class="no-print" style="width: 70px"></th>
                  </tr>
                </thead>
                <tbody id="tasksBody"></tbody>
              </table>
            </div>

            <div
              id="noDataMessage"
              class="text-center text-muted small mt-3 d-none"
            >
              No items found for the current filter.
            </div>
          </div>
        </div>
      </div>

      <!-- FOOTER -->
      <div class="footer-text">
        <span>‚ú® Designed with care by Mr.Mohamed Ali Ghonim ‚Äì ICU Head Nurse ‚ú®</span>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      let allItems = [];
      let statusChart = null;

      // Map status ‚Üí CSS classes
      function getStatusClasses(status) {
        const s = (status || '').toString().toLowerCase().trim();
        if (s === 'done') return { row: 'status-row-done', pill: 'status-done' };
        if (s === 'almost done')
          return { row: 'status-row-almost', pill: 'status-almost' };
        if (s === 'still pending')
          return { row: 'status-row-pending', pill: 'status-pending' };
        return { row: '', pill: '' };
      }

      function loadData() {
        google.script.run
          .withSuccessHandler(function (data) {
            allItems = data || [];
            updateSummaryAndChart();
            renderTable();
          })
          .getToDoData();
      }

      function handleRefresh() {
        loadData();
      }

      function updateSummaryAndChart() {
        const total = allItems.length;
        let doneCount = 0;
        let almostCount = 0;
        let pendingCount = 0;

        allItems.forEach((item) => {
          const s = (item.Status || '').toString().toLowerCase().trim();
          if (s === 'done') doneCount++;
          else if (s === 'almost done') almostCount++;
          else if (s === 'still pending') pendingCount++;
        });

        const donePct = total ? Math.round((doneCount * 100) / total) : 0;
        const almostPct = total ? Math.round((almostCount * 100) / total) : 0;
        const pendingPct = total ? Math.round((pendingCount * 100) / total) : 0;

        document.getElementById('totalTasks').textContent = total;
        document.getElementById('donePercent').textContent = donePct + '%';
        document.getElementById('almostPercent').textContent = almostPct + '%';
        document.getElementById('pendingPercent').textContent =
          pendingPct + '%';

        document.getElementById(
          'doneCountText'
        ).textContent = `${doneCount} item(s)`;
        document.getElementById(
          'almostCountText'
        ).textContent = `${almostCount} item(s)`;
        document.getElementById(
          'pendingCountText'
        ).textContent = `${pendingCount} item(s)`;

        const chartData = [doneCount, almostCount, pendingCount];

        const ctx = document.getElementById('statusChart').getContext('2d');

        if (statusChart) {
          statusChart.data.datasets[0].data = chartData;
          statusChart.update();
        } else {
          statusChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: ['Done', 'Almost done', 'Still pending'],
              datasets: [
                {
                  data: chartData,
                  backgroundColor: ['#198754', '#ffc107', '#dc3545'],
                  borderColor: '#ffffff',
                  borderWidth: 2
                }
              ]
            },
            options: {
              plugins: {
                legend: {
                  display: true,
                  position: 'bottom'
                }
              },
              cutout: '55%'
            }
          });
        }
      }

      function renderTable() {
        const tbody = document.getElementById('tasksBody');
        const filter = document.getElementById('statusFilter').value;
        const search = document
          .getElementById('searchInput')
          .value.toLowerCase()
          .trim();

        tbody.innerHTML = '';

        let filtered = allItems.slice();

        if (filter !== 'ALL') {
          filtered = filtered.filter(
            (item) =>
              (item.Status || '').toString().toLowerCase().trim() ===
              filter.toLowerCase().trim()
          );
        }

        if (search) {
          filtered = filtered.filter((item) => {
            const points = (item.Points || '').toString().toLowerCase();
            const comment = (item.Comment || '').toString().toLowerCase();
            return (
              points.includes(search) ||
              comment.includes(search)
            );
          });
        }

        if (!filtered.length) {
          document
            .getElementById('noDataMessage')
            .classList.remove('d-none');
        } else {
          document.getElementById('noDataMessage').classList.add('d-none');
        }

        filtered.forEach((item) => {
          const tr = document.createElement('tr');
          const classes = getStatusClasses(item.Status);
          if (classes.row) tr.classList.add(classes.row);

          const idCell = document.createElement('td');
          idCell.textContent = item['#'] || '';
          tr.appendChild(idCell);

          const dateCell = document.createElement('td');
          dateCell.textContent = item.Date || '';
          tr.appendChild(dateCell);

          const pointsCell = document.createElement('td');
          pointsCell.textContent = item.Points || '';
          tr.appendChild(pointsCell);

          const categoryCell = document.createElement('td');
          categoryCell.textContent = item.Category || '';
          tr.appendChild(categoryCell);

          const respCell = document.createElement('td');
          respCell.textContent = item.Responsibility || '';
          tr.appendChild(respCell);

          const statusCell = document.createElement('td');
          const pill = document.createElement('span');
          pill.classList.add('status-pill');
          if (classes.pill) pill.classList.add(classes.pill);
          pill.textContent = item.Status || '';
          statusCell.appendChild(pill);
          tr.appendChild(statusCell);

          const commentCell = document.createElement('td');
          commentCell.textContent = item.Comment || '';
          tr.appendChild(commentCell);

          const actionsCell = document.createElement('td');
          actionsCell.classList.add('no-print');
          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.className = 'btn btn-sm btn-outline-primary';
          editBtn.textContent = 'Edit';
          editBtn.onclick = function () {
            fillForm(item);
          };
          actionsCell.appendChild(editBtn);
          tr.appendChild(actionsCell);

          tbody.appendChild(tr);
        });
      }

      function fillForm(item) {
        document.getElementById('rowNumber').value = item.rowNumber || '';
        document.getElementById('idField').value = item['#'] || '';

        document.getElementById('dateInput').value = item.Date || '';
        document.getElementById('pointsInput').value = item.Points || '';
        document.getElementById('categoryInput').value = item.Category || '';
        document.getElementById('responsibilityInput').value =
          item.Responsibility || '';
        document.getElementById('statusInput').value = item.Status || '';
        document.getElementById('commentInput').value = item.Comment || '';
      }

      function resetForm() {
        document.getElementById('taskForm').reset();
        document.getElementById('rowNumber').value = '';
        document.getElementById('idField').value = '';
      }

      function handleSave() {
        const payload = {
          rowNumber: document.getElementById('rowNumber').value || null,
          '#': document.getElementById('idField').value || '',
          Date: document.getElementById('dateInput').value || '',
          Points: document.getElementById('pointsInput').value || '',
          Category: document.getElementById('categoryInput').value || '',
          Responsibility:
            document.getElementById('responsibilityInput').value || '',
          Status: document.getElementById('statusInput').value || '',
          Comment: document.getElementById('commentInput').value || ''
        };

        google.script.run
          .withSuccessHandler(function (data) {
            allItems = data || [];
            updateSummaryAndChart();
            renderTable();
            resetForm();
            alert('Saved successfully ‚úÖ');
          })
          .saveToDoItem(payload);
      }

      function handleDelete() {
        const rowNumber = document.getElementById('rowNumber').value;
        if (!rowNumber) {
          alert('Select an item (Edit) before deleting.');
          return;
        }

        if (!confirm('Are you sure you want to delete this item?')) {
          return;
        }

        google.script.run
          .withSuccessHandler(function (data) {
            allItems = data || [];
            updateSummaryAndChart();
            renderTable();
            resetForm();
            alert('Deleted successfully üóëÔ∏è');
          })
          .deleteToDoItem(Number(rowNumber));
      }

      document.addEventListener('DOMContentLoaded', function () {
        loadData();
      });
    </script>
  </body>
</html>
